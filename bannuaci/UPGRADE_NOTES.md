# 平話字輸入方案升級說明 (Báⁿ-uā-ci̍ IME Upgrade Notes)

## 版本 0.2.0 更新內容

### 主要變更

本次更新採用了**方案 B**（ASCII 羅馬字儲存 + comment_format 動態轉換）來解決之前發現的三個重大 bug。

### 問題解決

#### Bug 1: 特殊字元 + 聲調組合無法匹配
- **問題**：輸入 `saa` 只顯示聲調 1 的字（sa̤），不顯示其他聲調（sá̤, sâ̤, sa̤̍, sā̤）
- **原因**：Unicode 組合字元與聲調標記的交互導致 Rime 的 algebra 規則失效
- **解決方案**：詞庫改為儲存 ASCII 羅馬字（如 `saa3`），使用 `comment_format` 動態轉換為正確的平話字顯示

#### Bug 2: 多音節詞無法匹配
- **問題**：輸入 `aucau` 找不到「鏖糟 áu-cau」
- **原因**：詞庫使用連字號 `-` 連接音節，但 Rime 需要空格
- **解決方案**：音節之間使用空格分隔（如 `au2 lau1`）

#### Bug 3: 轉換錯誤
- **問題**：
  - 客 ka5 → bā（錯誤，應為 kā）
  - 囝 yor3 → piô̤（錯誤，應為 giô̤ⁿ）
  - 牙 or2 → bó̤（錯誤，應為 gó̤）
- **原因**：變數作用域錯誤，`buc_candidates` 在迴圈中被覆蓋
- **解決方案**：重寫轉換邏輯，移除有問題的初聲同化還原過程，改用直接轉換 + 字典查找

### 技術實現

#### 1. 詞庫格式變更

**舊格式**（使用 Unicode 平話字）：
```yaml
西	sā̤	5100
洗	sâ̤	5100
犀	sā̤
```

**新格式**（使用 ASCII 羅馬字）：
```yaml
西	saa1	5100
洗	saa3	5100
犀	saa1
```

#### 2. Schema 配置更新

**speller.algebra** 規則簡化：
- 移除複雜的 Unicode 字元處理規則
- 改為處理聲調數字：`derive/[1-8]$//`（支援無聲調輸入）
- 簡拼規則支援帶聲調和不帶聲調兩種模式

**preedit_format** 保持簡潔：
- 僅轉換基本特殊字元：`aa → a̤`、`ee → e̤`、`oo → o̤`、`y → ṳ`、`nn → ⁿ`
- 用於顯示使用者輸入時的即時轉換

**comment_format** 完整轉換（僅用於漢字輸出方案）：
- 步驟 1：添加連字號 `- xform/ /-/g`
- 步驟 2：將聲調數字轉換為組合變音符號（針對每個母音）
- 步驟 3：將特殊羅馬字轉換為 Unicode 組合字元
- 步驟 4：移除剩餘的聲調數字

#### 3. 字典整合

**新增資料來源**：
- 整合 `cpx-pron-data.lua`（11,564 個字元條目）
- 從 `hinghwa-ime/Pouleng.dict.yaml` 轉換（12,788 個條目）
- 總計：22,251 個成功轉換的條目
- 去重後：24,603 個條目

**轉換腳本**：`tools/convert_dict_v2.py`
- 新增 `BucRomanizer` 類別處理羅馬字轉換
- 實作去重機制（基於漢字 + 拼音組合）
- 修正變數作用域問題
- 生成詳細的轉換日誌

### 驗證結果

#### 測試案例

原本有問題的條目現在已正確轉換：

| 漢字 | 舊轉換（錯誤） | 新轉換（正確） |
|------|---------------|---------------|
| 客   | bā            | ka5 (kā)      |
| 囝   | piô̤          | gioo3 (giô̤)  |
| 牙   | bó̤           | goo2 (gó̤)    |

#### 特殊字元 + 聲調測試

輸入 `saa` 可以找到：
- 西 `saa1` → 顯示為 sā̤
- 犀 `saa1` → 顯示為 sā̤
- 洗 `saa3` → 顯示為 sâ̤
- 硒 `saa1` → 顯示為 sā̤

#### 多音節詞測試

詞庫中正確儲存：
- 鏖糟 `au2 lau1`（音節用空格分隔）
- 莆田 `po2 leng2`
- 福州 `hooh6 ciu1`

### 使用方式

#### 輸入範例

1. **帶聲調輸入**：
   - 輸入 `saa3` → 顯示候選詞「洗」，註釋顯示 `sâ̤`
   - 輸入 `ka5` → 顯示候選詞「客」，註釋顯示 `kā`

2. **無聲調輸入**：
   - 輸入 `saa` → 顯示所有聲調的候選詞（saa1, saa2, saa3, ...）
   - 輸入 `ka` → 顯示所有聲調的候選詞

3. **多音節詞**：
   - 輸入 `poleng` 或 `po2leng2` → 顯示「莆田」
   - 輸入 `aulau` → 顯示「鏖糟」

4. **簡拼**：
   - 輸入 `p` → 顯示所有 p 開頭的字
   - 輸入 `p5` → 顯示所有 p 開頭聲調 5 的字

### 檔案清單

#### 核心檔案
- `bannuaci/borhlang_bannuaci.schema.yaml` - 平話字輸出方案
- `bannuaci/borhlang_bannuaci_han.schema.yaml` - 漢字輸出方案
- `bannuaci/borhlang_bannuaci.dict.yaml` - 主詞庫（24,603 條目）

#### 工具腳本
- `tools/convert_dict_v2.py` - 字典轉換腳本（新版）
- `tools/generate_comment_format_v2.py` - 生成 comment_format 規則
- `tools/comment_format_rules_v2.txt` - 生成的規則（供參考）

#### 日誌檔案
- `bannuaci/conversion_log_v2.txt` - 轉換日誌（13,015 行）

### 下一步

1. **測試輸入法**：
   - 將 `bannuaci/` 資料夾複製到 Rime 使用者目錄
   - 重新部署 Rime
   - 測試各種輸入場景

2. **回報問題**：
   - 如發現任何轉換錯誤，請檢查 `conversion_log_v2.txt`
   - 記錄具體的輸入和預期輸出

3. **擴充詞庫**：
   - 可以繼續添加新詞彙到詞庫
   - 使用 ASCII 羅馬字格式（如 `saa3`）

### 技術細節

#### comment_format 轉換規則示例

```yaml
# 聲調 2（陽平）
- xform/([^a])a([^a0-9]*)2/$1á$2/      # ka2 → ká
- xform/^a([^a0-9]*)2/á$1/             # a2 → á

# 聲調 3（上聲）
- xform/([^a])a([^a0-9]*)3/$1â$2/      # ka3 → kâ
- xform/^a([^a0-9]*)3/â$1/             # a3 → â

# 特殊字元轉換
- xform/a([́̂̍̄]?)a/a̤$1/                # aa3 → â̤ (先轉 â，再轉 a̤)
- xform/nn/ⁿ/                          # nn → ⁿ
- xform/y([́̂̍̄]?)/ṳ$1/                # y3 → ŷ → ṳ̂
```

#### 母音優先順序

處理雙母音時，聲調標記的優先順序：
```
a > o > e > i > u > y
```

例如：
- `au2` → `áu`（標在 a 上）
- `oi3` → `ôi`（標在 o 上）
- `ia5` → `iā`（標在 a 上）

### 已知限制

1. **聲調 7、8**：部分入聲韻尾的字可能需要進一步驗證
2. **異讀字**：同一個字的多個讀音都會顯示，需要使用者根據語境選擇
3. **罕見字**：部分罕見字可能尚未收錄或拼音不完整

### 版本資訊

- **版本**：0.2.0
- **更新日期**：2025-12-07
- **主要貢獻者**：Siniong, Claude Sonnet 4.5
- **授權**：MPL 2.0

### 致謝

- hinghwa-ime 專案提供的基礎詞庫
- cpx-pron-data.lua 字元發音資料
- Rime 輸入法框架
